/*
  backgrid-paginator
  http://github.com/wyuenho/backgrid

  Copyright (c) 2013 Jimmy Yuen Ho Wong and contributors
  Licensed under the MIT @license.
*/
!function(a,b){"object"==typeof exports?module.exports=b(require("underscore"),require("backbone"),require("backgrid"),require("backbone.paginator")):"function"==typeof define&&define.amd?define(["underscore","backbone","backgrid","backbone.paginator"],b):b(a._,a.Backbone,a.Backgrid)}(this,function(a,b,c){"use strict";var d=c.Extension.PageHandle=b.View.extend({tagName:"li",events:{"click a":"changePage"},title:function(a){return"Page "+a.label},isRewind:!1,isBack:!1,isForward:!1,isFastForward:!1,initialize:function(b){var c=this.collection,d=c.state,e=d.currentPage,f=d.firstPage,g=d.lastPage;a.extend(this,a.pick(b,["isRewind","isBack","isForward","isFastForward"]));var h;this.isRewind?h=f:this.isBack?h=Math.max(f,e-1):this.isForward?h=Math.min(g,e+1):this.isFastForward?h=g:(h=+b.pageIndex,h=f?h+1:h),this.pageIndex=h,this.label=(b.label||(f?h:h+1))+"";var i=b.title||this.title;this.title=a.isFunction(i)?i({label:this.label}):i},render:function(){this.$el.empty();var a=document.createElement("a");a.href="#",this.title&&(a.title=this.title),a.innerHTML=this.label,this.el.appendChild(a);var b=this.collection,c=b.state,d=c.currentPage,e=this.pageIndex;return this.isRewind&&d==c.firstPage||this.isBack&&!b.hasPreviousPage()||this.isForward&&!b.hasNextPage()||this.isFastForward&&(d==c.lastPage||c.totalPages<1)?this.$el.addClass("disabled"):this.isRewind||this.isBack||this.isForward||this.isFastForward||c.currentPage!=e||this.$el.addClass("active"),this.delegateEvents(),this},changePage:function(a){a.preventDefault();var b=this.$el,c=this.collection;return b.hasClass("active")||b.hasClass("disabled")||(this.isRewind?c.getFirstPage({reset:!0}):this.isBack?c.getPreviousPage({reset:!0}):this.isForward?c.getNextPage({reset:!0}):this.isFastForward?c.getLastPage({reset:!0}):c.getPage(this.pageIndex,{reset:!0})),this}}),e=c.Extension.Paginator=b.View.extend({className:"backgrid-paginator",windowSize:10,slideScale:.5,controls:{rewind:{label:"《",title:"First"},back:{label:"〈",title:"Previous"},forward:{label:"〉",title:"Next"},fastForward:{label:"》",title:"Last"}},renderIndexedPageHandles:!0,pageHandle:d,goBackFirstOnSort:!0,pageSizeSelector:null,collectionEventsToReRender:["sync"],titles:{totalRecords:"Total items:",totalPages:"Total pages:"},initialize:function(b){var c=this;c.controls=a.defaults(b.controls||{},c.controls,e.prototype.controls),a.extend(c,a.pick(b||{},"windowSize","pageHandle","slideScale","goBackFirstOnSort","renderIndexedPageHandles","pageSizeSelector","titles"));var d=c.collection;a.each(this.collectionEventsToReRender,function(a){c.listenTo(d,a,c.render)}),c.listenTo(d,"backgrid:beforeSort",function(){c.goBackFirstOnSort&&(d.state.currentPage=d.state.firstPage)})},slideMaybe:function(a,b,c,d){return Math.round(c%d/d)},slideThisMuch:function(a,b,c,d,e){return~~(d*e)},_calculateWindow:function(){var a=this.collection,b=a.state,c=b.firstPage,d=+b.lastPage;d=Math.max(0,c?d-1:d);var e=Math.max(b.currentPage,b.firstPage);e=c?e-1:e;var f=this.windowSize,g=this.slideScale,h=Math.floor(e/f)*f;e<=d-this.slideThisMuch()&&(h+=this.slideMaybe(c,d,e,f,g)*this.slideThisMuch(c,d,e,f,g));var i=Math.min(d+1,h+f);return[h,i]},makeHandles:function(){var b=[],c=this.collection,d=this._calculateWindow(),e=d[0],f=d[1];if(this.renderIndexedPageHandles)for(var g=e;f>g;g++)b.push(new this.pageHandle({collection:c,pageIndex:g}));var h=this.controls;return a.each(["back","rewind","forward","fastForward"],function(a){var d=h[a];if(d){var e={collection:c,title:d.title,label:d.label};e["is"+a.slice(0,1).toUpperCase()+a.slice(1)]=!0;var f=new this.pageHandle(e);"rewind"==a||"back"==a?b.unshift(f):b.push(f)}},this),b},render:function(){if(this.$el.empty(),this.handles)for(var a=0,c=this.handles.length;c>a;a++)this.handles[a].remove();for(var d=this.handles=this.makeHandles(),e=document.createElement("ul"),a=0;a<d.length;a++)e.appendChild(d[a].render().el);this.el.appendChild(e);var f=$('<div class="info"></div>');if(f.append(this.createStatEl()),this.$el.append(f),this.pageSizeSelector&&this.pageSizeSelector.shouldRender()){if(!(this.pageSizeSelector instanceof b.View))throw new Error("pageSizeSelector must be instance of Backbone.View");f.append(this.pageSizeSelector.render().el)}return this},createStatEl:function(){var a=$('<div class="stat"></div>');return this.collection.state.totalRecords&&a.append("<span><b>"+this.titles.totalRecords+"</b>"+this.collection.state.totalRecords+"</span>"),this.collection.state.totalPages&&a.append("<span><b>"+this.titles.totalPages+"</b>"+this.collection.state.totalPages+"</span>"),a}});c.Extension.PageSizeSelector=b.View.extend({className:"page-size-selector",selectClassName:"",options:{},label:null,$select:null,initialize:function(c){if(c||(c={}),a.extend(this,a.pick(c,["options","label","selectClassName"])),!(this.collection&&this.collection instanceof b.PageableCollection))throw new Error("You must pass a collection and collection must be instance of Backbone.PageableCollection.")},events:{"change select":"changePageSize"},render:function(){if(this.$el.empty(),this.shouldRender()){var a=$("<label></label>");this.label&&a.text(this.label),this.createSelect(),a.append(this.$select),this.$el.append(a),this.delegateEvents()}return this},createSelect:function(){var b=this;this.$select=$("<select></select>"),this.selectClassName&&this.$select.addClass(this.selectClassName),a.each(this.options,function(a,c){var d=$("<option></option>");d.text(a),d.attr("value",c),(b.collection.state.pageSize!==!1&&b.collection.state.pageSize==c||b.collection.state.pageSize===!1&&"all"===c)&&d.prop("selected",!0),b.$select.append(d)})},changePageSize:function(){var a=!1,b=this.$select.val();"all"!==b&&(a=parseInt(b)),this.collection.state.currentPage=this.collection.state.firstPage,this.collection.state.pageSize=a,this.collection.fetch({reset:!0})},shouldRender:function(){return this.options&&0!=a.size(this.options)?!0:!1}})});